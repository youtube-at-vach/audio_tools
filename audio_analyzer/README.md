# Audio Analyzer v1.4.5

実験やプログラムの参考程度にお使い下さい。断り無く自由に使って下さい。

---

## 概要

このスクリプトは、音声信号の高調波解析を行うツールです。主な機能には、THD（全高調波歪）、THD+N、SNRの測定、音声信号のゲイン表示、周波数スイープや振幅スイープによる連続測定、テストトーンの出力、および新機能としてマッピング測定が含まれます。

- **作成者**: ChatGPT, vach, Jules, Gemini
- **日付**: 2024年10月16日  
- **Copyright**: pass  

---

## 特徴

- ピーク検出と高調波解析  
- THD（全高調波歪）および THD+N の測定  
- SINAD (Signal-to-Noise and Distortion Ratio) の測定 (THD+NのdB値の符号を反転させたものとして計算: `-(THD+N in dB)`)
- SNR（信号対雑音比）の測定  
- 入力振幅と測定振幅の比較によるゲイン表示  
- 各測定終了時に高調波解析結果を表示  
- 複数回の測定から得た平均結果と標準偏差を表示  
- 周波数スイープや振幅スイープによる連続測定  
- テストトーンの出力機能  
- 新機能: `--map` オプションによる周波数・振幅のマッピング測定  

---

## ファイル構成

- `audio_analyzer.py`: メインプログラム。音声信号の解析と測定を行います。  
- `distorsion_visualizer.py`: 歪みデータを視覚化します。  
- `aligner.py`: 信号のタイミング整列を行うユーティリティ。  
- `audiocalc.py`: オーディオ関連の計算処理を担当。   
- `requirement.txt`: 必要な Python パッケージを記載したファイル。  

---

## 必要な環境

- Python 3.8以降が必要です。  
- 必要なパッケージは `requirement.txt` に記載されています。インストールには以下を使用します:

```bash
pip install -r requirement.txt
```

---

## 使用方法

### メインプログラム `audio_analyzer.py`

音声信号の測定および高調波解析を行います。周波数や振幅の設定を指定し、測定結果を取得できます。

#### 基本コマンド

```bash
python audio_analyzer.py --frequency 1000 --amplitude -6 --duration 5.0
```

#### 主なオプション

| オプション | 説明 |
|-----------|------|
| `-f, --frequency` | 測定する基本周波数（デフォルト: 1000 Hz） |
| `-a, --amplitude` | トーンの振幅（デフォルト: -6 dBFS） |
| `-w, --window` | 窓関数の種類（デフォルト: blackmanharris） |
| `--duration` | 測定時間（デフォルト: 5秒） |
| `--bandpass` | バンドパスフィルターの適用 |
| `-sr, --sample-rate` | サンプリングレート（デフォルト: 48000 Hz） |
| `-oc, --output-channel` | 出力チャンネル（LまたはR、デフォルト: R） |
| `-d, --device` | 音声デバイスの番号 |
| `-n, --num_measurements` | 測定回数（デフォルト: 2回） |

### モードオプション（いずれか一つを選択）

- `--sweep-amplitude` 振幅スイープモード  
- `--sweep-frequency` 周波数スイープモード  
- `--map` マッピング測定モード  
- `--test` テストトーンの出力  
- `--calib` キャリブレーションモード（現在テスト中）

### 追加オプション

- `--output-csv`: 測定結果をCSVファイルに保存するファイル名  

---

## ビジュアライザ `distorsion_visualizer.py`

CSVファイルから歪みデータを読み取り、視覚化します。

#### 基本コマンド

```bash
python distorsion_visualizer.py sample.csv --device_name "Test Device"
```

#### オプション

| オプション | 説明 |
|-----------|------|
| `csv_file` | 歪みデータを含むCSVファイルのパス |
| `-d, --device_name` | タイトルに含めるデバイス名（任意） |
| `-a, --amplitude_type` | Output(dBFS) または Input(dBFS) を選択（デフォルト: Output） |
| `-c, --convert_to_dBVrms` | 振幅をdBVrmsに変換するオプション |
| `-p, --plot_type` | グラフの種類を選択: "contour" (等高線) または "3d" (3Dサーフェス)。デフォルトは等高線。 |
| `--color` | 等高線プロットで色を表示する（白黒の代わりにカラーマップを使用）。 |
| `--rotate` | 3Dプロットを自動で回転させる（アニメーション）。 |

---

## Audio Analyzer の主な関数と役割

- **generate_tone**: 指定されたパラメータで正弦波テストトーンを生成  
- **test_tone**: テストトーンを再生（エンターで停止）  
- **select_device**: 使用可能な音声デバイスの一覧表示と選択  
- **print_harmonic_analysis**: 高調波解析結果を表形式で表示  
- **measure**: 単一のトーンに対する測定を実施  
- **measure_noise**: 環境ノイズの測定とRMSレベル計算  
- **display_measurements** / **display_statics**: 測定値と統計結果を表示  
- **perform_measurements**: 周波数・振幅スイープの連続測定とCSV出力  

---

## 出力例

測定結果は以下のようなテーブルで表示されます（一部抜粋）:

```
=== 測定結果一覧 ===
┏━━━━━━━┳━━━━━━━━━━━┳━━━━━━━━━━━━┳━━━━━━━━━━━━━┳━━━━━━━━━━━━━┳━━━━━━━━━━┳━━━━━━━━━━━━━┳━━━━━━━━━━━━━┳━━━━━━━━━━━┳━━━━━━━━━━━┓
┃ 測定  ┃ 周波数(Hz) ┃ 振幅(dBFS) ┃ 出力(dBFS)  ┃ 入力(dBFS)  ┃ THD(%)   ┃ THD+N(%)    ┃ SINAD(dB)   ┃ SNR(dB)   ┃ ゲイン(dB) ┃
┡━━━━━━━╇━━━━━━━━━━━╇━━━━━━━━━━━━╇━━━━━━━━━━━━━╇━━━━━━━━━━━━━╇━━━━━━━━━━╇━━━━━━━━━━━━━╇━━━━━━━━━━━━━╇━━━━━━━━━━━╇━━━━━━━━━━━┩
│ 1     │ 1000.0    │ -6.00      │ -6.00       │ -6.05       │ 0.0012   │ 0.0100      │ 80.00       │ 80.05     │ -0.05     │
└───────┴───────────┴────────────┴─────────────┴─────────────┴──────────┴─────────────┴─────────────┴───────────┴───────────┘
```

---