# 新規測定プログラム製作手順

このドキュメントは、本リポジトリに新しいオーディオ測定プログラムを追加する際の標準的な手順を概説します。

## 1. 企画・設計

-   **アイデア確認**: `misc/future_tool_ideas.md` を確認し、既存の構想と重複がないか、参考にできる点がないかを確認します。
-   **目的の明確化**: 測定する具体的なオーディオ特性（例: THD+N, 周波数特性）を定義します。
-   **既存ツールの確認**: 類似機能を持つツールがないか確認し、可能であれば既存ツールを拡張します。
-   **機能リストアップ**: 必要な機能（入力信号、ユーザーパラメータ、出力形式など）をリストアップします。
-   **ライブラリ選定**: `numpy`, `scipy`, `sounddevice` 等、プロジェクト標準のライブラリを優先的に使用します。新規ライブラリの導入は慎重に検討します。

## 2. 開発環境の準備

-   **Pythonバージョン**: **3.9+** を使用します。
-   **依存関係**: `requirements.txt` を使って共通ライブラリをインストールします。`sounddevice` が依存するPortAudio等がシステムにインストールされていることを確認してください。

## 3. 実装

-   **モジュール構成**: 
    -   機能は専用ディレクトリ（例: `new_tool_analyzer/`）に配置し、`__init__.py` を含めます。
    -   メインスクリプトは `new_tool_analyzer.py` のように命名します。
-   **オーディオ入出力 (`sounddevice`)**:
    -   ユーザーがデバイスをIDまたは名前で選択できるようにします。
    -   `sd.playrec()`（一括処理）または `sd.InputStream`（リアルタイム処理）を適切に使い分けます。
    -   チャンネル選択は、録音後のNumpyスライス (`recorded_audio[:, [ch1, ch2]]`) で行います。
    -   ユーザーが指定したチャンネルインデックスがデバイスの能力範囲内にあることを必ず検証します。
-   **ロジックと表示の分離**: 解析ロジック（計算）と結果の表示ロジックを関数レベルで分離し、テストを容易にします。
-   **信号処理の注意点**:
    -   **フィルター**: IIRノッチフィルターは広帯域ノイズ測定に影響を与える可能性があるため、FFTベースのフィルタリングを推奨します。標準フィルター（A特性など）の実装は複雑なため、検証済みのSOS係数を使用することが望ましいです。
    -   **FFT**: 正確な振幅スペクトルを得るための正規化や、周波数ビン選択に注意します。

## 4. テスト

-   **事前テスト**: 開発着手前に `python3 -m unittest discover` を実行し、既存のテストがすべて成功することを確認します。
-   **単体テスト (`unittest`)**:
    -   主要な関数（信号生成、解析処理）の単体テストを作成します。
    -   ハードウェア依存部分（`sounddevice`呼び出し等）は `unittest.mock` でモック化します。
-   **全体のテスト**: 開発完了後、再度 `python3 -m unittest discover` を実行し、プロジェクト全体のテストが成功することを確認します。

## 5. ドキュメント

#### 5.1. ツール固有の `README.md`

各ツールディレクトリに、以下を含む `README.md` を作成します。

-   **概要**: ツールの目的と機能。
-   **依存ライブラリ**: インストール方法を含む。
-   **使用方法**: 基本的なコマンドライン例と主要なオプションの説明。
-   **出力結果の例**: コンソール出力やグラフのサンプル。
-   **注意事項**: 正しい測定のための前提条件など。

#### 5.2. プロジェクトルートの `README.md` 更新

新しいツールを追加したら、プロジェクトルートの `README.md` のツールリストを、以下のルールに従って更新します。

-   **言語**: 日本語で記述。
-   **項目名**: ツールの日本語名で開始。
-   **リンク**: ディレクトリ名をバッククォートで囲み、その中の `README.md` へリンクします。
    -   例: `- リサージュアナライザー ([`audio_lissajous_analyzer`](./audio_lissajous_analyzer/README.md)): （説明文）`
-   **説明文**: 専門用語を避け、平易な言葉で記述。太字などの装飾は使用しない。

## 6. プルリクエストとレビュー

-   変更をコミットし、GitHubでプルリクエストを作成します。
-   （協力者がいれば）レビューを受け、修正後にマージします。

## 7. その他

-   **ライセンス**: Unlicenseを適用します。
-   **ファイルエンコーディング**: すべてのテキストファイルをUTF-8で保存します。

## 8. 知見の記録

-   開発を通じて得られた新たな知見や将来のツール構想は、`misc/future_tool_ideas.md` に追記します。

