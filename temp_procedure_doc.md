# 新規測定プログラム製作手順 (New Measurement Program Production Procedure)

このドキュメントは、本リポジトリに新しいオーディオ測定プログラムを追加する際の標準的な手順を概説するものです。

## 1. 企画・設計 (Planning and Design)

-   **将来のアイデア確認**: まず `misc/future_tool_ideas.md` を確認し、既存の将来的なツール構想やアイデアに合致するものがないか、または参考にできる点がないかを確認します。
-   **目的の明確化**: 新しい測定プログラムが解決する課題、測定する具体的なオーディオ特性（例: THD+N, 周波数特性, IMDなど）を定義します。
-   **既存ツールの確認**: リポジトリ内に類似の機能を持つツールがないか確認します。既存ツールを拡張できる場合は、新規作成よりも優先します。
    -   **未カバーの測定カテゴリ特定**: 基本的なオーディオ測定カテゴリ（例：高調波歪み、周波数特性、相互変調歪み、ノイズ、ステレオ特性、過渡応答など）をリストアップし、未カバーの領域を特定します。例えば `audio_crosstalk_analyzer` はステレオ特性の未カバー領域（信号漏れ）に焦点を当てています。
-   **必要な機能のリストアップ**: もし協力者がいればレビューを受け、フィードバックに基づいて修正を行います。
    -   入力信号の種類（例: サイン波、矩形波、ホワイトノイズ、外部ファイル）
    -   ユーザーが設定可能なパラメータ（例: 周波数、振幅、テスト時間、FFTサイズ）
    -   出力形式（例: コンソールへのテキスト表示、グラフ表示、CSVファイルへの保存）
    -   対応するオーディオ規格や測定方法（例: SMPTE, DIN, CCIF for IMD）
-   **使用ライブラリの選定**: `numpy`, `scipy`, `sounddevice`, `matplotlib`, `rich`など、プロジェクトで共通して使用されているライブラリを基本とします。
-   **依存関係の確認**: 新たなサードパーティライブラリが必要な場合は、そのライブラリがプロジェクトの他の部分と競合しないか、ライセンスは適切かを確認します。可能であれば、既存のライブラリで代替できないか検討します。

## 2. 開発環境の準備 (Development Environment Setup)

-   **Pythonバージョン**: **Python 3.9+** を使用します。これにより、モダンな型ヒント構文 (`tuple[int]` など) が利用できます。
-   **依存関係のインストール**: プロジェクトルートの `requirements.txt` を使って、共通の依存ライブラリをインストールします。
    ```bash
    pip install -r requirements.txt
    ```
    - ツール固有の依存関係がある場合は、そのツールのディレクトリにある `requirements.txt` を使って追加でインストールします。
    - **システムライブラリの確認**: `sounddevice` が依存するPortAudio (`libportaudio2` など) がシステムにインストールされていることを確認してください。これは実行時エラーの一般的な原因です。
-   **Gitリポジトリ**: `git clone` または `git pull` でリポジトリを最新の状態に更新します。

## 3. 実装 (Implementation)

-   **モジュール構成**: 
    -   プログラムの主たる機能は、リポジトリルート直下に作成する専用のディレクトリ（例: `new_tool_analyzer/`）に配置します。
    -   メインスクリプトは `new_tool_analyzer/new_tool_analyzer.py` のように命名します。
    -   ディレクトリ内には `__init__.py` を配置し、Pythonパッケージとして認識できるようにします。
-   **信号生成**: 
    -   必要なテスト信号を生成する関数を実装します。可能であれば既存の信号生成ツール（例: `audio_signal_generator`）の機能を活用します。
-   **オーディオ入出力 (Audio I/O)**:
    -   `sounddevice` ライブラリを使用します。
    -   **デバイス選択**: ユーザーがオーディオデバイスをIDまたは名前で選択できるようにします。`rich` を使ってデバイスリストを分かりやすく表示することを推奨します。
    -   **ストリーミング方式の選択**:
        -   **一括再生・録音**: `sd.playrec()` は、決まった長さの信号を再生し、同時に録音する場合に適しています。多くの測定ツールでこの方式が使われています。
        -   **リアルタイム処理**: `sd.InputStream` や `sd.Stream` のコールバック方式は、リアルタイムでのデータ可視化（例: `audio_lissajous_analyzer`）など、連続的なデータ処理が必要な場合に適しています。
    -   **チャンネルマッピング**:
        -   `sd.playrec()` や `sd.Stream` の `mapping` 引数（または `input_mapping`/`output_mapping`）は、物理チャンネルを1ベースのインデックスで指定するために使用します。
        -   `data` (再生用Numpy配列) のチャンネル数 (`data.shape[1]`) は、`output_mapping` リストの要素数と厳密に一致させる必要があります。
        -   `input_mapping` を使用する場合、`channels` パラメータは `len(input_mapping)` と設定します。
    -   **チャンネルインデックスの事前検証**: ユーザーが指定したチャンネルインデックスが、`sd.query_devices()` で取得した `max_input_channels` や `max_output_channels` の範囲内にあることを必ず検証し、範囲外の場合は親切なエラーメッセージを表示します。
    -   **PortAudioライブラリの簡易チェック**: `sd.check_hostapi()` を呼び出し、失敗した場合はPortAudioのインストールを促すメッセージを表示することを推奨します。
-   **解析処理 (Analysis Processing)**:
    -   FFT、ウィンドウ関数、フィルタリングなど、測定に必要な信号処理を `numpy` や `scipy.signal` を活用して実装します。
    -   FFTを用いた解析では、正確な振幅スペクトルを得るための正規化や、既知の周波数成分を正確に捉えるための周波数ビン選択/補間処理に注意を払います。
    -   無音や非常に短い信号など、エッジケースを考慮し、エラーで終了する代わりに警告を出すなど、堅牢な処理を実装します。
-   **結果表示 (Results Display)**:
    -   **CLI出力**: `rich` ライブラリを積極的に活用し、`Table` や `Panel` を使って結果を整形し、分かりやすく表示します。
    -   **グラフ表示**: 必要に応じて `matplotlib` を用いたグラフ表示機能を実装します。リサージュ図形における `plt.axis('equal')` のように、プロットの種類に応じた適切な設定を適用します。
-   **コマンドラインインターフェース (CLI)**:
    -   `argparse` を使用して、ユーザーがパラメータを指定できるCLIを設計します。
    -   `--help` メッセージを充実させ、各オプションの役割を明確に説明します。
-   **エラーハンドリング**:
    -   デバイスが見つからない場合、不正なパラメータが指定された場合など、予期されるエラーを適切に処理し、`rich` を使ってユーザーフレンドリーなエラーメッセージ（可能であれば解決策も）を表示します。
-   **コーディング規約**:
    -   PEP 8 に準拠したコーディングスタイルを心がけます。
    -   型ヒント (`typing` モジュールまたは Python 3.9+ の組み込み型) を適切に使用し、コードの可読性と保守性を高めます。

## 4. テスト (Testing)

-   **単体テスト (Unit Tests)**:
    -   主要な関数（信号生成、解析処理など）に対して単体テストを作成します。
    -   Pythonの `unittest` フレームワークを使用し、テストスクリプトは `new_tool_analyzer/test_new_tool_analyzer.py` のように命名します。
    -   テストケースでは、既知の入力に対する期待される出力を検証します。`unittest.mock` を活用して、ハードウェアに依存する部分（例: `sounddevice` の呼び出し）をモック化します。
-   **テストの実行**:
    -   リポジトリのルートディレクトリから **`python3 -m unittest discover`** を実行し、プロジェクト全体のテストが成功することを確認します。これにより、変更が他のツールに影響を与えていないことを保証します。
-   **テスト環境**:
    -   テストコードが依存するライブラリがテスト環境で利用可能であること、また、必要なシステムレベルの依存関係（例：PortAudio）が満たされていることを確認します。

## 5. ドキュメント作成 (Documentation)

#### 5.1. ツール固有の `README.md` 作成

各ツールディレクトリ（例: `new_tool_analyzer/`）には、必ず `README.md` を作成します。このファイルには、以下の情報を明確かつ簡潔に記載してください。

-   **ツールの概要**:
    -   このツールが何をするものなのか、一文で説明します。
    -   どのような目的（例: スピーカーの位相チェック、アンプの歪み測定）で使用されるのかを記述します。

-   **依存ライブラリ**:
    -   このツールが依存するPythonライブラリをリストアップします。
    -   プロジェクト共通の `requirements.txt` に含まれるライブラリと、このツール固有のライブラリを明記します。
    -   インストールコマンドの例を記載します。
        ```markdown
        # 共通ライブラリのインストール
        pip install -r ../requirements.txt

        # このツール固有のライブラリのインストール (もしあれば)
        pip install -r requirements.txt
        ```

-   **使用方法**:
    -   基本的なコマンドラインの実行例を記載します。
    -   `--help` で表示される主要なオプション（特に重要なもの）をリストアップし、それぞれの役割とデフォルト値を説明します。

-   **出力結果の例**:
    -   ツールの実行結果（コンソール出力や生成されるグラフ）のサンプルを記載し、ユーザーがどのような情報を得られるのかを示します。

-   **注意事項**:
    -   正しい測定に必要な前提条件（例: オーディオインターフェースのループバック設定、マイクの配置）や、測定結果に影響を与える可能性のある要因について記述します。

#### 5.2. プロジェクトルートの `README.md` 更新

新しいツールを追加したら、プロジェクトのトップレベルにある `README.md` のツールリストを更新します。以下のルールに厳密に従ってください。

1.  **リストへの追加**:
    -   既存のツールリストの中から、新ツールのカテゴリに最も近い場所を見つけて項目を追加します。リストの順序は、関連性の高いツールが近くに配置されるように意識してください。

2.  **表記ルール**:
    -   **言語**: 全てのツールの説明は日本語で記述します。
    -   **項目名**: 各ツールリストの項目は、ツールの日本語名で開始します。
    -   **リンク形式**: ツールのディレクトリ名はバッククォート（` `` `）で囲み、そのディレクトリ内の `README.md` ファイルへのリンクとします。
        -   例: `- リサージュアナライザー ([\`audio_lissajous_analyzer\`](./audio_lissajous_analyzer/README.md)): （ここに説明文）`
    -   **説明文**:
        -   ツールが「何をするのか」「どのような機能を持つのか」を明確に記述します。
        -   専門用語を避け、平易な言葉で説明することを心がけてください。
    -   **装飾**: ツール名や説明文に太字やイタリックなどの特別な文字装飾は使用しません。

## 6. プルリクエストとレビュー (Pull Request and Review)

-   変更内容をコミットし、GitHub上でプルリクエストを作成します。
-   （もし協力者がいれば）レビューを受け、フィードバックに基づいて修正を行います。
-   全てのチェックが通ったら、メインブランチにマージします。

## 7. その他 (Miscellaneous)

-   **ライセンス**: 本リポジトリの他のツールと同様に、Unlicense を適用し、著作権を放棄します。READMEにその旨を記載します。
-   **ファイルエンコーディング**: すべてのテキストファイル（.py, .md, .txt など）は UTF-8 で保存します。

## 8. 知見の記録と将来構想へのフィードバック (Logging Knowledge and Feedback to Future Concepts)

-   **新たな知見・アイデアの記録**: 作業完了後、開発プロセスを通じて得られた新たな知見、または将来的に有用と思われる新しい測定ツールのアイデアが生まれた場合は、`misc/future_tool_ideas.md` に追記して下さい。これは将来のツール開発のための貴重なリソースとなります。

---
この手順はあくまでガイドラインであり、開発するツールの特性や規模に応じて適宜調整してください。