name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: read

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      with:
        persist-credentials: false

    - name: Set up Python 3.10
      uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6.1.0
      with:
        python-version: "3.10"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
        # Pin setuptools to avoid distutils issues if necessary
        # pip install "setuptools<70.0.0" 

    - name: Convert Icon
      run: |
        magick app_icon.png -define icon:auto-resize=256,128,64,48,32,16 app_icon.ico

    - name: Build (onefile) with PyInstaller
      run: |
        pyinstaller --onefile --windowed --name MeasureLab --icon=app_icon.ico --add-data "src;src" --collect-all backports --distpath dist/onefile --workpath build/onefile main_gui.py

    - name: Build (onedir) with PyInstaller
      run: |
        pyinstaller --windowed --name MeasureLab --icon=app_icon.ico --add-data "src;src" --collect-all backports --distpath dist/onedir --workpath build/onedir main_gui.py

    - name: Package Windows release assets
      shell: pwsh
      run: |
        # タグ名を取得（refs/tags/... から取り除く）
        $tag = $env:GITHUB_REF -replace 'refs/tags/',''
        if (-not $tag) { $tag = 'untagged' }

        $outDir = "dist/release"
        New-Item -ItemType Directory -Force -Path $outDir | Out-Null

        $base = "MeasureLab-$tag-windows-x64"
        Compress-Archive -Path "dist/onefile/MeasureLab.exe" -DestinationPath "$outDir/$base-onefile.zip" -Force
        Compress-Archive -Path "dist/onedir/MeasureLab" -DestinationPath "$outDir/$base-onedir.zip" -Force

    - name: Extract CHANGELOG for version
      id: changelog
      shell: bash
      run: |
        python misc/extract_changelog.py ${GITHUB_REF#refs/tags/} > release_notes.md
        # If empty, use a default message
        if [ ! -s release_notes.md ]; then
          echo "Release ${GITHUB_REF#refs/tags/}" > release_notes.md
        fi

    - name: Release Windows
      uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2.5.0
      if: startsWith(github.ref, 'refs/tags/')
      with:
        token: ${{ secrets.RELEASE_TOKEN }}
        files: dist/release/*.zip
        body_path: release_notes.md

  build-linux:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      with:
        persist-credentials: false

    - name: Set up Python 3.10
      uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6.1.0
      with:
        python-version: "3.10"

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libasound2-dev libxcb-cursor0

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install "setuptools<70.0.0"
        pip install -r requirements.txt
        pip install pyinstaller

    - name: Build standalone binary with PyInstaller
      run: |
        mkdir -p libs
        pyinstaller --onefile --windowed --name MeasureLab --icon=app_icon.png --add-data "src:src" --exclude-module matplotlib --collect-all backports main_gui.py

    - name: Build AppImage
      run: |
        chmod +x build_appimage.sh
        ./build_appimage.sh

    - name: Rename AppImage for release
      shell: bash
      run: |
        set -euo pipefail
        tag="${GITHUB_REF#refs/tags/}"
        mkdir -p dist/release
        shopt -s nullglob
        candidates=(MeasureLab*.AppImage)
        if [ ${#candidates[@]} -eq 0 ]; then
          echo "No AppImage found" >&2
          exit 1
        fi
        mv "${candidates[0]}" "dist/release/MeasureLab-${tag}-linux-x86_64.AppImage"

    - name: Extract CHANGELOG for version
      id: changelog
      run: |
        python misc/extract_changelog.py ${GITHUB_REF#refs/tags/} > release_notes.md
        # If empty, use a default message
        if [ ! -s release_notes.md ]; then
          echo "Release ${GITHUB_REF#refs/tags/}" > release_notes.md
        fi

    - name: Release Linux
      uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2.5.0
      if: startsWith(github.ref, 'refs/tags/')
      with:
        token: ${{ secrets.RELEASE_TOKEN }}
        files: dist/release/*.AppImage
        body_path: release_notes.md
